
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>INOPNC · 건설현장관리</title>

  <!-- PWA 설정 -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0068FE">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="INOPNC 현장관리">
  <meta name="description" content="건설현장 작업 관리 Progressive Web App">
  
  <!-- 아이콘 -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
  <link rel="apple-touch-icon" href="/icon-192x192.png">

  <!-- 폰트 & 아이콘 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800;900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <style>
  :root{
    --p:#0068FE; --t:#111827; --bg:#f6f8fb; --b:#e5e7eb; --g:#6b7280;
    --space:16px; --lg:24px; --radius:10px;
    --fz-body:clamp(14px, 1.9vw, 16px);
    --fz-small:clamp(11px, 1.5vw, 12px);
    --fz-label:clamp(12px, 1.7vw, 13px);
    --fz-btn:clamp(12px, 1.9vw, 14px);
    --fz-h2:clamp(15px, 2.2vw, 16px);
  }
  [data-theme="dark"] { 
    --p:#4c8dff; --t:#f0f4ff; --bg:#0a1929; --b:#1e3a5f; --g:#7aa3ff;
    --shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  }
  [data-theme="light"] {
    --shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,Poppins,system-ui,-apple-system,sans-serif;
    color:var(--t); background:var(--bg); font-size:var(--fz-body);
    transition: background-color 0.3s, color 0.3s;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* 헤더 */
  header{position:sticky;top:0;z-index:10;background:#fff;color:#1A254F; transition: background-color 0.3s, color 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
  [data-theme="dark"] header { background: #1e3a5f; color: #f0f4ff; }
  .header-inner{max-width:1100px;margin:0 auto;padding:var(--space);display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px}
  .header-left{display:flex;justify-content:flex-start;align-items:center;gap:12px}
  .header-center{display:flex;justify-content:center;align-items:center}
  .header-right{display:flex;justify-content:flex-end;align-items:center;gap:10px}
  .brand{font-family:Poppins;font-weight:900;font-size:26px;letter-spacing:.2px;color:var(--t); transition: color 0.3s; text-align:center;}

  /* 좁은 버튼 */
  .btn-narrow{min-width:auto;width:28px;height:24px;padding:0;justify-content:center;}

  /* 테마 토글 스위치 */
  .theme-toggle-container{position:relative;display:inline-block}
  .theme-toggle-input{opacity:0;width:0;height:0}
  .theme-toggle-label{
    display:inline-block;width:44px;height:24px;background:#ccc;border-radius:12px;cursor:pointer;position:relative;transition:all 0.3s ease;
  }
  .theme-toggle-label:before{
    content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:all 0.3s ease;box-shadow:0 2px 4px rgba(0,0,0,0.2);
  }
  .theme-toggle-input:checked + .theme-toggle-label{background:var(--p)}
  .theme-toggle-input:checked + .theme-toggle-label:before{transform:translateX(20px)}
  [data-theme="dark"] .theme-toggle-label{background:#4a5568}
  [data-theme="dark"] .theme-toggle-input:checked + .theme-toggle-label{background:var(--p)}

  /* 공통 */
  .number{font-family:Inter;font-weight:800}
  .app{max-width:1100px;margin:0 auto;padding:var(--space) var(--space) 80px}
  .card{
    background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--space);border:1px solid var(--b);
    transition: all 0.3s ease;
  }
  [data-theme="dark"] .card { 
    background: #142f4b; 
    border-color: #1e3a5f; 
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }
  .row{display:flex;gap:var(--space);flex-wrap:wrap}
  .row>*{flex:1 1 220px}
  label{font-size:var(--fz-label);font-weight:800;color:var(--t); display:inline-block;margin-bottom:6px; transition: color 0.3s;}
  input,select,textarea{
    width:100%;padding:10px;border:1px solid var(--b);border-radius:10px;background:#fff;font-size:var(--fz-body);
    transition: all 0.3s ease;
  }
  [data-theme="dark"] input, 
  [data-theme="dark"] select, 
  [data-theme="dark"] textarea { 
    background: #1e3a5f; 
    color: #f0f4ff; 
    border-color: #2d5a8b;
  }
      input::placeholder, textarea::placeholder{color:var(--g); transition: color 0.3s;}
    
    /* 다크모드 날짜선택도구 컬러 */
    [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    [data-theme="dark"] input[type="month"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:6px;height:38px;padding:0 12px;border-radius:10px;border:1px solid var(--b);background:#fff;font-weight:800;cursor:pointer;white-space:nowrap;font-size:var(--fz-btn);min-width:88px;line-height:1;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  .btn:hover::before {
    left: 100%;
  }
  [data-theme="dark"] .btn { 
    background: #1e3a5f; 
    border-color: #2d5a8b; 
    color: #f0f4ff;
  }
  .btn.primary{background:var(--p);border-color:var(--p);color:#fff;box-shadow: 0 4px 12px rgba(0, 104, 254, 0.3);}
  .btn.primary:hover{transform: translateY(-2px);box-shadow: 0 6px 16px rgba(0, 104, 254, 0.4);}
  .btn.warn{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .btn.block{width:100%}
  .text-red{color:#dc2626}
  .text-blue{color:var(--p)}

  /* 테이블 */
  .table-scroll{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table{width:100%;border-collapse:collapse;min-width:820px}
  .table th,.table td{padding:10px 8px;border-bottom:1px solid #eef1f5;text-align:left;font-size:14px;transition: background-color 0.3s;}
  .table th{background:#fafafa;font-weight:700}
  .table tfoot td{background:#fafafa;font-weight:800}
  .table tbody tr:hover{background: rgba(0, 104, 254, 0.05);}
  [data-theme="dark"] .table { color:#f0f4ff }
  [data-theme="dark"] .table th { background:#1e3a5f }
  [data-theme="dark"] .table tbody tr:hover{background: rgba(76, 141, 255, 0.1);}
  [data-theme="dark"] .table tfoot td{background:#142f4b}

  /* 캘린더 */
  .calbar{display:grid;grid-template-columns:1fr 1fr;gap:var(--space);align-items:end}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border-bottom:1px solid var(--b);background:#fff;padding:8px 0}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:min-content;gap:0;background:#fff}
  .cell{border-right:1px solid var(--b);border-bottom:1px solid var(--b);padding:8px;background:#fff;display:flex;flex-direction:column;cursor:pointer;transition: all 0.3s ease;position: relative;min-height:80px;overflow:visible;border-radius:0}
  .cell:nth-child(7n){border-right:none}
  .cell:hover{background: rgba(0, 104, 254, 0.05);}
  [data-theme="dark"] .cal-head { background:#142f4b; border-color:var(--b) }
  [data-theme="dark"] .calendar { background:#142f4b; border-color:var(--b) }
  [data-theme="dark"] .cell { background:#142f4b; border-color:var(--b) }
  .date{font-size:12px;font-weight:900;margin-bottom:4px}
  .pill{margin-top:2px;padding:2px 4px;font-size:11px;overflow:visible;display:block;white-space:normal;word-break:break-word;transition: all 0.3s ease;line-height:1.2;}
  .pill.site{color:var(--p);font-weight:600}
  .pill.worker{color:var(--t);font-weight:400}
  .pill.worker .md{font-weight:700;color:var(--t)}
  .pill.worker .md.zero{color:#dc2626;font-weight:700}
  
  /* 작업모달 공수 입력 필드 스타일 */
  .log-2row .md.zero{color:#dc2626;font-weight:700}
  .mini{font-size:var(--fz-small);color:var(--g)}

  /* 모달 */
  dialog{border:none;border-radius:16px;max-width:720px;width:92vw;padding:0;overflow:hidden;animation: modalFadeIn 0.3s ease;}
  dialog::backdrop{background:#00000066;animation: backdropFadeIn 0.3s ease;}
  .modal{background:#fff;animation: modalSlideIn 0.3s ease;}
  [data-theme="dark"] dialog, [data-theme="dark"] .modal { background:#142f4b; color:#f0f4ff }
  .modal header,.modal footer{padding:10px var(--space);border-bottom:1px solid var(--b)}
  .modal footer{border-top:1px solid var(--b);display:flex;gap:8px;justify-content:flex-end}
  #modalRows{padding:var(--space);display:grid;gap:12px}
  .log-2row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;align-items:end}
  .log-2row .md{width:80px}
  .log-2row .row2{grid-column:1 / -1;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}

  /* 경비관리 입력폼 */
  .expense-form{display:grid;grid-template-columns:1fr 1fr;gap:var(--space)}
  .expense-form .form-field{display:flex;flex-direction:column}

  /* 작업로그 연동 필터 */
  .log-filter{display:grid;grid-template-columns:1fr 1fr;gap:var(--space);align-items:end}

  /* 아코디언 스타일 */
  .accordion-header{user-select:none;cursor:pointer;transition:all 0.3s ease;color:var(--t)}
  .accordion-header:hover{background:rgba(0,104,254,0.05)}
  .accordion-content{background:#fff;transition:all 0.3s ease;display:none}
  .accordion.active .accordion-header i{transform:rotate(180deg)}
  .accordion.active .accordion-content{display:block}
  [data-theme="dark"] .accordion-content{background:#142f4b}
  [data-theme="dark"] .accordion-header{color:#f0f4ff;background:#1e3a5f}

  /* 금전출납부 */
  .ledger-container{display:flex;flex-direction:column;gap:12px}
  .ledger-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .ledger-row .ledger-col{flex:1 1 280px}

  /* 수익분석 */
  .profit-filter{display:grid;grid-template-columns:1fr 1fr;gap:var(--space);align-items:end}
  [data-theme="dark"] .profit-filter label{color:#f0f4ff}
  
  /* 수익분석 카드 다크모드 */
  .profit-card{transition:all 0.3s ease}
  [data-theme="dark"] .profit-card{background:#142f4b;border-color:#1e3a5f}
  
  /* 수익분석 아코디언 헤더 다크모드 */
  .profit-accordion-header{transition:all 0.3s ease;background:#f8f9fa}
  [data-theme="dark"] .profit-accordion-header{background:#1e3a5f;color:#f0f4ff}
  
  /* 수익분석 제목 다크모드 */
  .profit-title{transition:color 0.3s ease}
  [data-theme="dark"] .profit-title{color:#7aa3ff}
  
  /* 수익분석 섹션 제목 다크모드 */
  .profit-section-title{transition:color 0.3s ease}
  [data-theme="dark"] .profit-section-title{color:#f0f4ff}

  /* 관리자설정 */
  .admin-grid{display:grid;grid-template-columns:1fr;gap:16px;max-width:100%}
  .admin-add-row{display:grid;gap:12px;margin-bottom:12px}
  .admin-add-row.worker-grid{grid-template-columns:repeat(3, 1fr)}
  .admin-add-row.site-grid{grid-template-columns:repeat(4, 1fr)}
  .admin-add-row > div{display:flex;flex-direction:column;min-width:0}
  .admin-add-row label{margin-bottom:4px}
  .admin-add-row .btn-container{display:flex;justify-content:flex-end}
  .table-wrap{overflow-x:auto}
  .admin-table{width:100%;min-width:720px}
  .admin-table th,.admin-table td{padding:3px;border-bottom:1px solid var(--b);text-align:left;font-size:clamp(12px,1.7vw,14px);transition: background-color 0.3s;}
  .admin-table th{background:#fafafa;font-weight:700}
  .admin-table tbody tr:hover{background: rgba(0, 104, 254, 0.05);}
  [data-theme="dark"] .admin-table th { background:#1e3a5f }
  [data-theme="dark"] .admin-table tbody tr:hover{background: rgba(76, 141, 255, 0.1);}
  .admin-table .actions{text-align:right;white-space:nowrap}
  .admin-table th.actions, .admin-table td.actions{padding-left:2px}
  .wName,.wDaily,.sCompany,.sName,.sBudget{width:100%;min-width:0}
  .wDaily,.sBudget{text-align:right}
  .admin-table .btn{min-width:auto;padding:6px 10px;height:38px;transition: all 0.3s ease;}
  .btn-add-worker{height:38px;min-width:auto;padding:6px 10px}
  
  /* 공통 삭제 버튼 스타일 */
  .admin-table .btn--delete {
    min-width: auto;
    padding: 6px 10px;
    height: 38px;
    transition: all 0.3s ease;
    width: calc(100% * 0.9); /* 기존 폭 대비 10% 축소 */
  }
  
  /* 작업자 관리 테이블 열 비율 */
  .admin-table--workers th:nth-child(1), .admin-table--workers td:nth-child(1) { width: 50%; } /* 작업자명 */
  .admin-table--workers th:nth-child(2), .admin-table--workers td:nth-child(2) { width: 50%; } /* 일당 */
  .admin-table--workers th:nth-child(3), .admin-table--workers td:nth-child(3) { width: auto; } /* 삭제버튼 */
  
  /* 현장 관리 테이블 열 비율 */
  .admin-table--sites th:nth-child(1), .admin-table--sites td:nth-child(1) { width: 20%; } /* 회사 */
  .admin-table--sites th:nth-child(2), .admin-table--sites td:nth-child(2) { width: 40%; } /* 현장명 */
  .admin-table--sites th:nth-child(3), .admin-table--sites td:nth-child(3) { 
    width: 40%; /* 총예산 */
    min-width: 120px;
  }
  .admin-table--sites th:nth-child(4), .admin-table--sites td:nth-child(4) { width: auto; } /* 삭제버튼 */
  
  /* 회사 입력박스 확장 기능 */
  .admin-table--sites .sCompanyRow {
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
  }
  .admin-table--sites .sCompanyRow:focus {
    width: 120% !important; /* 텍스트 크기에 맞게 적절히 확장 */
    z-index: 10;
    position: relative;
    min-width: 120px;
  }
  
  /* 현장명 입력박스 확장 기능 */
  .admin-table--sites .sNameRow {
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
  }
  .admin-table--sites .sNameRow:focus {
    width: 130% !important; /* 텍스트 크기에 맞게 적절히 확장 */
    z-index: 10;
    position: relative;
    min-width: 140px;
  }
  
  /* 360px 제한 및 모바일 최적화 */
  .admin-add-row.worker-grid,
  .admin-add-row.site-grid {
    max-width: 360px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .admin-table--workers,
  .admin-table--sites {
    max-width: 360px;
    margin-left: auto;
    margin-right: auto;
  }

  /* 하단 네비 - 애니메이션 제거 */
  .bottom-nav{position:fixed;bottom:0;left:0;right:0;z-index:20;background:var(--p);display:grid;grid-template-columns:repeat(4,1fr);box-shadow:0 -4px 12px rgba(0,0,0,0.1); border-radius:0 !important;transition: all 0.3s ease;}
  [data-theme="dark"] .bottom-nav { background:#1e3a5f; box-shadow:0 -4px 12px rgba(0,0,0,0.5) }
  .nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;color:#fff;cursor:pointer;border:none;background:transparent;transition: all 0.3s; border-radius:0 !important;position: relative;}
  .nav-btn i{font-size:20px;margin-bottom:4px;transition: transform 0.3s ease;}
  .nav-btn span{font-size:9px;font-weight:400;transition: all 0.3s ease;font-family:Inter,sans-serif;letter-spacing:0.2px;}
  .nav-btn.active{background:#ffffff22;}
  .nav-btn:hover{background:#ffffff33;}
  .nav-btn.active:hover{background:#ffffff44;}
  
  /* 다크모드 네비게이션 마우스 오버 컬러 */
  [data-theme="dark"] .nav-btn:hover{background:rgba(76, 141, 255, 0.3);}
  [data-theme="dark"] .nav-btn.active{background:rgba(76, 141, 255, 0.4);}
  [data-theme="dark"] .nav-btn.active:hover{background:rgba(76, 141, 255, 0.5);}

  /* 아코디언 */
  .accordion{border:1px solid var(--b);border-radius:10px;margin-bottom:10px;overflow:hidden;transition: all 0.3s ease;}
  .accordion-header{background:#f8fafc;padding:12px 16px;font-weight:800;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition: all 0.3s ease;user-select:none;}
  [data-theme="dark"] .accordion-header { background:#1e3a5f; color:#f0f4ff }
  .accordion-content{display:none;padding:16px;transition: all 0.3s ease;background:#fff;}
  [data-theme="dark"] .accordion-content { background:#142f4b; color:#f0f4ff }
  .accordion.active .accordion-content{display:block;animation: slideDown 0.3s ease;}
  .accordion.active .accordion-header i{transform:rotate(180deg)}
  .accordion-header i{transition:transform .3s;color:var(--g)}
  .accordion-header:hover{background:#f1f5f9}
  [data-theme="dark"] .accordion-header:hover{background:#2d5a8b}

  /* 총계행 - 다크모드 최적화 */
  .totals-row{font-weight:800;background:#f0f9ff;animation: highlightRow 0.5s ease;}
  [data-theme="dark"] .totals-row { background:#142f4b }
  [data-theme="dark"] .totals-row td { background: #142f4b; }
  .totals-row td{text-align:left !important}

  /* 순이익 카드 - 파란색 테두리 제거 */
  .profit-summary-card { 
    background:#f0f9ff; 
    border-radius:10px; 
    padding:12px; 
    margin-top:16px;
    animation: slideInLeft 0.5s ease;
  }
  [data-theme="dark"] .profit-summary-card { 
    background:#142f4b;
  }

  /* 범용 라운드 */
  :where(.card,.btn,input,select,textarea,.cell,.pill,dialog,.modal,.accordion,.accordion-header,.accordion-content,.profit-summary-card){ border-radius:10px !important; }

  /* 애니메이션 */
  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes backdropFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes modalSlideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  @keyframes slideDown {
    from { max-height: 0; opacity: 0; }
    to { max-height: 500px; opacity: 1; }
  }
  @keyframes slideInLeft {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes highlightRow {
    0% { background-color: rgba(0, 104, 254, 0.2); }
    100% { background-color: inherit; }
  }

  /* 오프라인 상태 표시 */
  .offline-indicator {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: #dc2626;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    display: none;
    animation: slideDown 0.3s ease;
  }
  .offline-indicator.show {
    display: block;
  }

  /* 로딩 스피너 */
  .loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* 반응형 디자인 */
  @media (max-width: 768px) {
    .app{padding:12px 12px 80px}
    .card{padding:12px}
    .btn{height:40px;min-width:72px;padding:0 10px}
    .admin-add-row{gap:8px;margin-bottom:8px}
    .admin-add-row.worker-grid{grid-template-columns:1fr}
    .admin-add-row.site-grid{grid-template-columns:1fr}
    .wName,.wDaily,.sCompany,.sName,.sBudget{width:100%;min-width:0}
    .admin-add-row .btn-container{grid-column:1 / -1;justify-content:flex-end;margin-top:8px}
    .admin-table{min-width:0}
    .admin-table th,.admin-table td{padding:4px}
    .admin-table .wName,.admin-table .sName{min-width:100px}
    .header-inner{padding:12px;gap:8px}
    .brand{font-size:24px}
    .btn-narrow{width:26px;height:24px}
    
    /* 768px 이하에서 max-width 제한 해제 */
    .admin-add-row.worker-grid,
    .admin-add-row.site-grid,
    .admin-table--workers,
    .admin-table--sites {
      max-width: 100%;
      margin-left: 0;
      margin-right: 0;
    }
    
    /* 모바일에서 입력박스 확장 기능 조정 */
    .admin-table--sites .sCompanyRow:focus,
    .admin-table--sites .sNameRow:focus {
      width: 125% !important; /* 텍스트 크기에 맞게 적절히 확장 */
      min-width: 120px !important;
    }
  }
  @media (max-width: 480px) {
    .btn{min-width:60px}
    input,select,textarea{padding:8px}
    .admin-table th{font-size:11px}
    .admin-table th,.admin-table td{padding:3px}
    .header-inner{padding:10px;gap:6px}
    .brand{font-size:22px}
    .calbar{grid-template-columns:1fr;gap:8px}
    .btn-narrow{width:24px;height:24px}
    
    /* 현장관리 테이블의 총예산 열 최소 너비 조정 */
    .admin-table--sites th:nth-child(3), .admin-table--sites td:nth-child(3) { 
      min-width: 100px;
    }
    
    /* 480px 이하에서 입력박스 확장 기능 조정 */
    .admin-table--sites .sCompanyRow:focus,
    .admin-table--sites .sNameRow:focus {
      width: 130% !important; /* 텍스트 크기에 맞게 적절히 확장 */
      min-width: 110px !important;
    }
  }
  @media (max-width: 360px) {
    .admin-table{min-width:0}
    .admin-table .btn{padding:4px 8px}
    .header-inner{padding:8px;gap:4px}
    .brand{font-size:20px}
    .btn-narrow{width:22px;height:24px}
    
    /* 360px 이하에서 현장관리 테이블의 총예산 열 최소 너비 더 줄임 */
    .admin-table--sites th:nth-child(3), .admin-table--sites td:nth-child(3) { 
      min-width: 80px;
    }
    
    /* 360px 이하에서 입력박스 확장 기능 조정 */
    .admin-table--sites .sCompanyRow:focus,
    .admin-table--sites .sNameRow:focus {
      width: 140% !important; /* 텍스트 크기에 맞게 적절히 확장 */
      min-width: 100px !important;
    }
  }
  </style>
</head>

<body>
  <!-- 오프라인 상태 표시기 -->
  <div id="offlineIndicator" class="offline-indicator">
    <i class="fas fa-wifi-slash"></i> 오프라인 상태입니다
  </div>

  <header>
    <div class="header-inner">
              <div class="header-left">
          <button class="btn btn-narrow" id="btnBack" title="뒤로가기">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div class="brand" id="brandLogo" style="cursor: pointer;">INOPNC</div>
        </div>
        <div class="header-center">
          <!-- 중앙 영역은 비워둠 -->
        </div>
      <div class="header-right">
        <button class="btn btn-narrow" id="btnRefresh" title="새로고침">
          <i class="fas fa-sync-alt"></i>
        </button>
        <div class="theme-toggle-container">
          <input type="checkbox" id="themeToggle" class="theme-toggle-input">
          <label for="themeToggle" class="theme-toggle-label"></label>
        </div>
        <!-- PWA 앱 설치 버튼 -->
        <button class="btn" id="installAppBtn" style="display:none;">
          <i class="fas fa-download"></i> 앱 설치
        </button>
      </div>
    </div>
  </header>

  <div class="app">
    <section id="view" aria-live="polite"></section>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active" data-route="home">
      <i class="fas fa-home"></i>
      <span>홈</span>
    </button>
    <button class="nav-btn" data-route="expense">
      <i class="fas fa-receipt"></i>
      <span>경비관리</span>
    </button>
    <button class="nav-btn" data-route="profit">
      <i class="fas fa-chart-line"></i>
      <span>수익분석</span>
    </button>
    <button class="nav-btn" data-route="admin">
      <i class="fas fa-cog"></i>
      <span>관리자설정</span>
    </button>
  </nav>

  <!-- ================== Templates ================== -->
  <!-- 홈 -->
  <template id="homeTpl">
    <div class="card">
      <div class="calbar" role="group" aria-label="달력 이동">
        <div><label for="monthPicker">월</label><input class="w-month" type="month" id="monthPicker" aria-label="월 선택" /></div>
        <div><label for="homeWorker">작업자</label><select id="homeWorker"><option value="">전체</option></select></div>
      </div>
      <div class="cal-head" style="margin-top:var(--space)">
        <div class="mini">일</div><div class="mini">월</div><div class="mini">화</div><div class="mini">수</div><div class="mini">목</div><div class="mini">금</div><div class="mini">토</div>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>

    <div class="card" style="margin-top:var(--lg);">
      <div class="accordion">
        <div class="accordion-header">
          <h2 style="margin:0; font-size:var(--fz-h2); color:var(--g); font-weight:800">
            출력현황
          </h2>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="accordion-content">
          <div class="row" style="align-items:end">
            <div class="mini">작업자 미선택 시 해당 월 전체 표시</div>
            <div style="flex:1 1 auto"></div>
            <button class="btn primary" id="btnExportHome">
              <i class="fas fa-file-excel"></i> 출력 엑셀 내보내기
            </button>
          </div>
          <div class="table-scroll" style="margin-top:10px">
            <table class="table" id="homeListTable">
              <thead>
                <tr>
                  <th>작업자</th><th>일자</th><th>현장</th><th>공수</th><th>총급여</th><th>세금(3.3%)</th><th>실수령액</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="totals-row">
                  <td colspan="3">합계</td>
                  <td id="totalHours" class="number">0</td>
                  <td id="totalSalary" class="number">0원</td>
                  <td id="totalTax" class="number text-red">0원</td>
                  <td id="totalNet" class="number">0원</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- 경비관리 -->
  <template id="expenseTpl">
    <div class="grid-1">
      <!-- 입력폼 -->
      <div class="card">
        <h2 style="margin:0 0 var(--space); font-size:var(--fz-h2); color:var(--g)">경비 입력</h2>
        <div class="expense-form">
          <div class="form-field"><label for="exSite">현장</label><select id="exSite"></select></div>
          <div class="form-field"><label for="exDate">사용일</label><input type="date" id="exDate"></div>
          <div class="form-field"><label for="exWorker">작업자</label><input id="exWorker" placeholder=""></div>
          <div class="form-field"><label for="exCategory">항목</label><input id="exCategory" placeholder="항목명"></div>
          <div class="form-field"><label for="exAmount">금액</label><input type="number" id="exAmount" min="0" step="1" inputmode="numeric" pattern="[0-9]*"></div>
          <div class="form-field"><label for="exVendor">사용처</label><input id="exVendor" placeholder="가게/거래처"></div>
          <div class="form-field"><label for="exAddress">주소</label><input id="exAddress" placeholder="도로명/지번"></div>
          <div class="form-field"><label for="exMemo">메모</label><input id="exMemo" placeholder="비고"></div>
        </div>
        <div class="row" style="gap:8px;margin-top:6px">
          <button class="btn" id="btnExcelFill">
            <i class="fas fa-file-excel"></i> 엑셀 업로드로 자동입력
          </button>
          <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none">
          <button class="btn primary block" id="btnSaveExpense">
            <i class="fas fa-save"></i> 지출 저장
          </button>
        </div>
      </div>

      <!-- 작업로그 연동 -->
      <div class="card" style="margin-top:var(--lg);">
        <div class="accordion">
          <div class="accordion-header">
            <h2 style="margin:0; font-size:var(--fz-h2); color:var(--g)">
              <i class="fas fa-link"></i> 작업로그 연동
            </h2>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="accordion-content">
            <div class="log-filter">
              <div><label for="linkMonth">월</label><input class="w-month" type="month" id="linkMonth"></div>
              <div><label for="linkWorker">작업자</label><select id="linkWorker"><option value="">전체</option></select></div>
            </div>
            <div class="mini" style="margin:8px 0 12px">캘린더(홈)에 입력된 데이터와 연동되어 보여집니다.</div>
            <div class="table-scroll">
              <table class="table" id="logLinkTable">
                <thead><tr><th>일자</th><th>현장</th><th>작업자</th><th>공수</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 금전출납부 -->
    <div class="card" style="margin-top: var(--lg);">
      <h2 style="margin:0 0 var(--space); font-size:var(--fz-h2); color:var(--g)">
        금전출납부
      </h2>
      <div class="ledger-container">
        <div class="ledger-row">
          <div class="ledger-col">
            <label for="ledgerSite">현장</label>
            <select id="ledgerSite"></select>
          </div>
          <div class="ledger-col">
            <label for="ledgerMonth">월</label>
            <input class="w-month" type="month" id="ledgerMonth">
          </div>
        </div>

        <div class="ledger-section">
          <div class="accordion">
            <div class="accordion-header">
              <div style="font-weight:900;margin:0">
                인건비 현황
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
              <div class="table-scroll">
                <table class="table" id="laborTable">
                  <thead>
                    <tr>
                      <th>작업자</th><th>일자</th><th>현장</th><th>공수</th><th>총급여</th><th>세금(3.3%)</th><th>실수령액</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr class="totals-row">
                      <td colspan="3">합계</td>
                      <td id="laborTotalHours" class="number">0</td>
                      <td id="laborTotalSalary" class="number">0원</td>
                      <td id="laborTotalTax" class="number text-red">0원</td>
                      <td id="laborTotalNet" class="number">0원</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="ledger-section">
          <div class="accordion">
            <div class="accordion-header">
              <div style="font-weight:900;margin:0">
                경비 현황
              </div>
              <i class="fas fa-chevron-down"></i>
            </div>
            <div class="accordion-content">
              <div class="table-scroll">
                <table class="table" id="expenseTable">
                  <thead>
                    <tr>
                      <th>사용일</th><th>작업자</th><th>항목</th><th>금액</th><th>사용처</th><th>주소</th><th>메모</th><th>삭제</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                  <tfoot>
                    <tr class="totals-row">
                      <td colspan="3">합계</td>
                      <td id="expenseTotalAmount" class="number">0원</td>
                      <td colspan="4"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="profit-summary-card">
          <div style="text-align:center; width:100%">
            <div style="font-size:clamp(14px, 1.9vw, 16px); font-weight:800; margin-bottom:8px">
              순수익 계산
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:8px; flex-wrap:wrap">
              <span class="number" id="calcBudget">0원</span>
              <span class="text-red">-</span>
              <span class="number" id="calcLabor">0원</span>
              <span class="text-red">-</span>
              <span class="number" id="calcExpense">0원</span>
              <span>=</span>
              <span class="number text-blue" id="calcProfit">0원</span>
            </div>
          </div>
        </div>

        <div class="ledger-row">
          <button class="btn primary block" id="btnExportLedger">
            <i class="fas fa-download"></i> 금전출납 엑셀
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- 수익분석 -->
  <template id="profitTpl">
    <div class="card">
      <h2 class="profit-title" style="margin:0 0 var(--space); font-size:var(--fz-h2); color:var(--g)">
        수익분석
      </h2>
      <div class="profit-filter">
        <div><label for="profitSite">현장</label><select id="profitSite"><option value="">전체</option></select></div>
        <div><label for="profitMonth">월</label><input class="w-month" type="month" id="profitMonth"></div>
      </div>

      <div class="row" style="margin: var(--lg) 0 var(--space)">
        <div class="card profit-card" style="flex:1 1 200px;text-align:center">
          <div class="mini">총 예산</div>
          <div id="profitCardTotalBudget" class="number" style="font-size:22px;font-weight:900;margin-top:8px">0원</div>
        </div>
        <div class="card profit-card" style="flex:1 1 200px;text-align:center">
          <div class="mini">인건비(총급여)</div>
          <div id="profitCardTotalLabor" class="number" style="font-size:22px;font-weight:900;margin-top:8px">0원</div>
        </div>
        <div class="card profit-card" style="flex:1 1 200px;text-align:center">
          <div class="mini">경비지출</div>
          <div id="profitCardTotalExpense" class="number" style="font-size:22px;font-weight:900;margin-top:8px">0원</div>
        </div>
        <div class="card profit-card" style="flex:1 1 200px;text-align:center">
          <div class="mini">순이익</div>
          <div id="profitCardNetProfit" class="number text-blue" style="font-size:22px;font-weight:900;margin-top:8px">0원</div>
        </div>
      </div>

      <div class="accordion active" style="margin-top: var(--space)">
        <div class="accordion-header profit-accordion-header" style="font-weight:900;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;transition:all 0.3s ease;color:var(--t)">
          <span>인건비 현황</span>
          <i class="fas fa-chevron-down" style="transition:transform 0.3s ease"></i>
        </div>
        <div class="accordion-content" style="padding:12px 0">
          <div class="table-scroll">
            <table class="table" id="payWorkerTable">
              <thead>
                <tr>
                  <th>작업자</th><th>년-월</th><th>현장</th><th>공수</th><th>총급여</th><th>세금(3.3%)</th><th>실수령액</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr class="totals-row">
                  <td colspan="3">합계</td>
                  <td id="payTotalHours" class="number">0</td>
                  <td id="payTotalSalary" class="number">0원</td>
                  <td id="payTotalTax" class="number text-red">0원</td>
                  <td id="payTotalNet" class="number">0원</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="card profit-card" style="margin-top: var(--space)">
        <div class="profit-section-title" style="font-weight:900;margin-bottom:8px;color:var(--t)">
          금전출납
        </div>
        <div class="table-scroll">
          <table class="table" id="siteFinanceTable">
            <thead>
              <tr>
                <th>년-월(누적)</th><th>현장</th><th>총 예산</th><th>인건비(총급여)</th><th>경비지출</th><th>순이익</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr class="totals-row">
                <td colspan="3">합계</td>
                <td id="financeTotalLabor" class="number">0원</td>
                <td id="financeTotalExpense" class="number">0원</td>
                <td id="financeTotalProfit" class="number text-blue">0원</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </template>

  <!-- 관리자설정 -->
  <template id="adminTpl">
    <div class="admin-grid">
      <div class="card">
        <h2 style="margin:0 0 var(--space); font-size:var(--fz-h2); color:var(--g)">
          <i class="fas fa-user-cog"></i> 작업자 관리
        </h2>
        <div class="admin-add-row worker-grid">
          <div><label for="admWorkerName">작업자명</label><input id="admWorkerName" class="wName" placeholder="김작업"></div>
          <div><label for="admDaily">일당</label><input id="admDaily" type="number" min="0" step="1" placeholder="150000" inputmode="numeric" pattern="[0-9]*" class="wDaily"></div>
          <div class="btn-container"><button class="btn primary btn-add-worker" id="btnAddWorker"><i class="fas fa-plus"></i> 추가</button></div>
        </div>
        <div class="table-wrap">
          <table class="admin-table admin-table--workers" id="workerTable">
            <thead>
              <tr>
                <th>작업자명</th>
                <th>일당</th>
                <th class="actions"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 var(--space); font-size:var(--fz-h2); color:var(--g)">
          <i class="fas fa-building"></i> 현장 관리
        </h2>
        <div class="admin-add-row site-grid">
          <div><label for="admCompanyName">회사</label><input id="admCompanyName" class="sCompany" placeholder="INOPNC"></div>
          <div><label for="admSiteName">현장명</label><input id="admSiteName" class="sName" placeholder="시흥시청역"></div>
          <div><label for="admSiteBudget">총 예산</label><input id="admSiteBudget" type="number" min="0" step="1" placeholder="80000000" inputmode="numeric" pattern="[0-9]*" class="sBudget"></div>
          <div class="btn-container"><button class="btn primary btn-add-worker" id="btnAddSite"><i class="fas fa-plus"></i> 추가</button></div>
        </div>
        <div class="table-wrap">
          <table class="admin-table admin-table--sites" id="siteTable">
            <thead>
              <tr>
                <th>회사</th>
                <th>현장명</th>
                <th>총 예산</th>
                <th class="actions"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </template>

  <!-- 작업 모달 -->
  <template id="logTpl">
    <dialog id="logModal">
      <div class="modal">
        <header>
          <div style="font-weight:900;color:#fff" id="modalDate">
            <i class="fas fa-calendar-alt"></i> 작업기록
          </div>
        </header>
        <div id="modalRows"></div>
        <footer>
          <button class="btn" id="btnAddRow"><i class="fas fa-plus"></i> 추가</button>
          <button class="btn" id="btnCloseModal"><i class="fas fa-times"></i> 닫기</button>
          <button class="btn primary" id="btnSaveLogs"><i class="fas fa-save"></i> 저장</button>
        </footer>
      </div>
    </dialog>
  </template>

  <script>
  /* ===== PWA 상태 관리 ===== */
  const pwaState = {
    isOnline: navigator.onLine,
    deferredPrompt: null,
    isInstalled: false
  };

  /* ===== Supabase 설정 ===== */
  const SUPABASE_URL = 'https://pkrgosfznqzklabzjllv.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrcmdvc2Z6bnF6a2xhYnpqbGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNDg1MjUsImV4cCI6MjA3MDYyNDUyNX0.-PsE0Cpgoonjw5ZSwzI6fUb3O9WQLpBbwl59DUCGBj4';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===== 데이터 저장소/상태 ===== */
  const db = { sites: [], workers: [], workLogs: [], expenses: [] };
  const KR = n => (n || 0).toLocaleString('ko-KR');
  const fmtYM = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  const fmtYMD = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

  /* 최근 90일 범위(로딩 최적화) */
  function getFromDate(days=90){
    const d = new Date(); d.setDate(d.getDate()-days);
    return fmtYMD(d);
  }

  /* ===== 앱 상태 ===== */
  const appState = {
    currentRoute: 'home',
    viewStates: {
      home: { month: '', worker: '' },
      expense: { site: '', date: '', worker: '', category: '', amount: '', vendor: '', address: '', memo: '', ledgerSite:'', ledgerMonth:'' },
      profit: { site: '', month: '' },
      admin: { workerName: '', daily: '', companyName: '', siteName: '', budget: '' }
    }
  };

  /* ===== 공용 유틸 ===== */
  const siteName  = id => (db.sites.find(s => s.id === id) || {}).name || '';
  const workerById = id => db.workers.find(w => w.id === id) || null;
  const workerName = id => (workerById(id) || {}).name || '';

  function fillSiteSelect(sel){
    const includeAll = sel.id !== 'exSite';
    let ops = includeAll ? '<option value="">전체</option>' : '';
    ops += db.sites.map(s => `<option value="${s.id}">${(s.company_name||'')+' '+(s.name||'')}</option>`).join('');
    sel.innerHTML = ops;
  }
  function fillWorkerSelect(sel){
    sel.innerHTML = db.workers.map(w=>`<option value="${w.id}">${w.name}</option>`).join('');
  }

  /* ===== 집계 함수 (중복 제거) ===== */
  function computeProfitLaborRows(siteId, month, homeSiteId=null){
    const [Y, M] = month ? month.split('-').map(Number) : [null, null];
    const inMonth = d => {
      if (!month) return true;
      const dt = new Date(d);
      return dt.getFullYear() === Y && dt.getMonth() + 1 === M;
    };

    const siteFilter = siteId || homeSiteId;
    const logs = (siteFilter ? db.workLogs.filter(r=>r.site_id===siteFilter) : db.workLogs)
                  .filter(r=> inMonth(r.date))
                  .sort((a,b)=> a.date.localeCompare(b.date));

    // 년-월별로 그룹화하여 누적 계산
    const groupedByMonth = {};
    logs.forEach(log => {
      const monthKey = log.date.substring(0, 7); // YYYY-MM
      if (!groupedByMonth[monthKey]) {
        groupedByMonth[monthKey] = [];
      }
      groupedByMonth[monthKey].push(log);
    });

    const rows = [];
    Object.keys(groupedByMonth).sort().forEach(monthKey => {
      const monthLogs = groupedByMonth[monthKey];
      const workerGroups = {};
      
      // 작업자별로 그룹화
      monthLogs.forEach(log => {
        const workerId = log.worker_id;
        if (!workerGroups[workerId]) {
          workerGroups[workerId] = {
            worker_id: workerId,
            site_id: log.site_id,
            month: monthKey,
            totalMd: 0,
            totalSalary: 0,
            totalTax: 0,
            totalNet: 0
          };
        }
        
        const w = workerById(workerId) || {};
        const salary = (log.md || 0) * (w.daily || 0);
        const tax = Math.round(salary * 0.033);
        const net = salary - tax;
        
        workerGroups[workerId].totalMd += log.md || 0;
        workerGroups[workerId].totalSalary += salary;
        workerGroups[workerId].totalTax += tax;
        workerGroups[workerId].totalNet += net;
      });

      // 누적 데이터를 행으로 변환
      Object.values(workerGroups).forEach(group => {
        const w = workerById(group.worker_id) || {};
        rows.push({
          worker: w.name || '(미등록)',
          month: group.month,
          site: siteName(group.site_id),
          md: group.totalMd,
          salary: KR(group.totalSalary) + '원',
          tax: '-' + KR(group.totalTax) + '원',
          net: KR(group.totalNet) + '원',
          worker_id: group.worker_id
        });
      });
    });

    return rows;
  }

  function renderProfitLaborTable(table, rows){
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    let totalHours = 0, totalSalary = 0, totalTax = 0, totalNet = 0;
    
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.worker}</td>
        <td>${row.month}</td>
        <td>${row.site}</td>
        <td>${row.md}</td>
        <td>${row.salary}</td>
        <td class="text-red">${row.tax}</td>
        <td>${row.net}</td>
      `;
      tbody.appendChild(tr);
      
      totalHours += row.md;
      totalSalary += parseInt(row.salary.replace(/[^\d]/g, ''));
      totalTax += parseInt(row.tax.replace(/[^\d]/g, ''));
      totalNet += parseInt(row.net.replace(/[^\d]/g, ''));
    });
    
    // 합계 업데이트
    const set = (id, val) => { 
      const el = table.querySelector('#' + id); 
      if(el) el.textContent = val; 
    };
    set('payTotalHours', totalHours);
    set('payTotalSalary', KR(totalSalary) + '원');
    set('payTotalTax', '-' + KR(totalTax) + '원');
    set('payTotalNet', KR(totalNet) + '원');
  }

  function computeLaborRows(siteId, month, homeSiteId=null){
    const [Y, M] = month ? month.split('-').map(Number) : [null, null];
    const inMonth = d => {
      if (!month) return true;
      const dt = new Date(d);
      return dt.getFullYear() === Y && dt.getMonth() + 1 === M;
    };

    const siteFilter = siteId || homeSiteId;
    const logs = (siteFilter ? db.workLogs.filter(r=>r.site_id===siteFilter) : db.workLogs)
                  .filter(r=> inMonth(r.date))
                  .sort((a,b)=> a.date.localeCompare(b.date));

    const rows = logs.map(log=>{
      const w = workerById(log.worker_id) || {};
      const salary = (log.md||0) * (w.daily||0);
      const tax = Math.round(salary*0.033);
      const net = salary - tax;
      return {
        worker: w.name || '(미등록)',
        date: log.date,
        site: siteName(log.site_id),
        md: log.md,
        salary: KR(salary)+'원',
        tax: '-'+KR(tax)+'원',
        net: KR(net)+'원',
        worker_id: log.worker_id
      };
    });

    const totalHours = logs.reduce((s,l)=> s+(l.md||0), 0);
    const totalGross = logs.reduce((s,l)=> {
      const w = workerById(l.worker_id) || {};
      return s + (l.md||0) * (w.daily||0);
    }, 0);
    const totalTax = Math.round(totalGross*0.033);
    const totalNet = totalGross - totalTax;

    return { rows, totalHours, totalGross, totalTax, totalNet };
  }

  function computeExpenseRows(siteId, month, homeSiteId=null){
    const [Y, M] = month ? month.split('-').map(Number) : [null, null];
    const inMonth = d => {
      if (!month) return true;
      const dt = new Date(d);
      return dt.getFullYear() === Y && dt.getMonth() + 1 === M;
    };

    const siteFilter = siteId || homeSiteId;
    const exps = (siteFilter ? db.expenses.filter(e=>e.site_id===siteFilter) : db.expenses)
                .filter(e=> inMonth(e.date))
                .sort((a,b)=> a.date.localeCompare(b.date));

    const rows = exps.map(e => ({
      date: e.date,
      worker_name: e.worker_name || workerName(e.worker_id) || '',
      category: e.category,
      amount: KR(e.amount)+'원',
      vendor: e.vendor || '',
      address: e.address || '',
      memo: e.memo || '',
      id: e.id
    }));
    const total = exps.reduce((s,e)=> s+(e.amount||0), 0);
    return { rows, total };
  }

  /* ===== 렌더 함수 (중복 제거) ===== */
  function renderLaborTable(targetEl, laborRows, totalHours, totalGross, totalTax, totalNet, idPrefix='labor'){
    const tbody = targetEl.querySelector('tbody');
    tbody.innerHTML = '';
    laborRows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.worker}</td><td>${r.date}</td><td>${r.site}</td><td>${r.md}</td><td>${r.salary}</td><td class="text-red">${r.tax}</td><td>${r.net}</td>`;
      tbody.appendChild(tr);
    });
    const set = (id, val) => { const el=targetEl.querySelector('#'+id); if(el) el.textContent = val; };
    set(`${idPrefix}TotalHours`,   totalHours);
    set(`${idPrefix}TotalSalary`,  KR(totalGross)+'원');
    set(`${idPrefix}TotalTax`,     '-'+KR(totalTax)+'원');
    set(`${idPrefix}TotalNet`,     KR(totalNet)+'원');
  }
  function renderExpenseTable(targetEl, expenseRows, expenseTotal, withDelete){
    const tbody = targetEl.querySelector('tbody');
    tbody.innerHTML='';
    expenseRows.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.date}</td><td>${row.worker_name}</td><td>${row.category}</td><td>${row.amount}</td><td>${row.vendor}</td><td>${row.address}</td><td>${row.memo}</td>${withDelete? `<td><button class="btn warn" onclick="deleteExpense(${row.id})">삭제</button></td>` : '<td></td>'}`;
      tbody.appendChild(tr);
    });
    const totEl = targetEl.querySelector('#expenseTotalAmount');
    if (totEl) totEl.textContent = KR(expenseTotal)+'원';
  }

  /* ===== 홈 ===== */
  function initHome(){
    const mp = document.getElementById('monthPicker');
    if (!appState.viewStates.home.month) {
      mp.value = fmtYM(new Date());
    }
    const workerSel = document.getElementById('homeWorker');
    workerSel.innerHTML = '<option value="">전체</option>' + db.workers.map(w=>`<option value="${w.id}">${w.name}</option>`).join('');

    const rerender = () => { renderCal(); renderHomeList(); };
    mp.onchange = rerender; workerSel.onchange = rerender;
    renderCal(); renderHomeList();
    
    // 아코디언 초기화
    document.querySelectorAll('.accordion-header').forEach(h=> h.addEventListener('click', ()=> h.parentElement.classList.toggle('active')));
  }
  function renderCal(){
    const cal = document.getElementById('calendar');
    const [yy, mm] = (document.getElementById('monthPicker').value || fmtYM(new Date())).split('-').map(Number);
    const first = new Date(yy, mm-1, 1);
    const start = new Date(first); start.setDate(1 - first.getDay());
    const end = new Date(yy, mm, 0);
    const weeks = Math.ceil((first.getDay() + end.getDate()) / 7);

    cal.innerHTML = '';
    for (let i=0;i<weeks*7;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      const iso = fmtYMD(d);
      const inMonth = d.getMonth() === (mm-1);

      const cell = document.createElement('div');
      cell.className='cell';
      cell.style.opacity = inMonth ? 1 : 0.5;
      cell.innerHTML = `<div class="date">${d.getDate()}</div>`;

      const logs = db.workLogs.filter(w=>w.date===iso);
      if (logs.length){
        // 모든 로그 데이터를 표시 (생략 없음)
        logs.forEach((log, index) => {
          // 현장명(4글자)
          const sitePill = document.createElement('div');
          sitePill.className='pill site';
          const s4 = siteName(log.site_id).slice(0,4);
          sitePill.textContent = s4;
          cell.appendChild(sitePill);
          
          // 작업자명/공수
          const workerPill = document.createElement('div');
          workerPill.className='pill worker';
          const workerName = workerById(log.worker_id)?.name || '';
          const md = log.md || 0;
          const mdSpan = document.createElement('span');
          mdSpan.className = `md ${(md === 0 || md === 0.5) ? 'zero' : ''}`;
          mdSpan.textContent = md;
          workerPill.textContent = `${workerName}/`;
          workerPill.appendChild(mdSpan);
          cell.appendChild(workerPill);
        });
      } else {
        const none = document.createElement('div');
        none.className = 'mini';
        none.textContent = '기록 없음';
        cell.appendChild(none);
      }
      cell.onclick = () => openLogModal(iso);
      cal.appendChild(cell);
    }
  }
  function renderHomeList(){
    const tbody = document.querySelector('#homeListTable tbody');
    tbody.innerHTML='';

    const ym = document.getElementById('monthPicker').value || fmtYM(new Date());
    const wId = document.getElementById('homeWorker').value;
    const [Y,M] = ym.split('-').map(Number);
    const inMonth = d => { const dt=new Date(d); return dt.getFullYear()===Y && dt.getMonth()+1===M; };

    const logs = db.workLogs
      .filter(r=> inMonth(r.date) && (wId ? r.worker_id===wId : true))
      .sort((a,b)=>a.date.localeCompare(b.date));

    let totalSalary=0,totalTax=0,totalNet=0,totalHours=0;
    logs.forEach(r=>{
      const w = workerById(r.worker_id)||{};
      const salary = (r.md||0)*(w.daily||0);
      const tax = Math.round(salary*0.033);
      const net = salary - tax;
      totalSalary+=salary; totalTax+=tax; totalNet+=net; totalHours+=(r.md||0);

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${w.name||'(미등록)'}</td>
        <td>${r.date}</td>
        <td>${siteName(r.site_id)}</td>
        <td>${r.md}</td>
        <td>${KR(salary)}원</td>
        <td class="text-red">-${KR(tax)}원</td>
        <td>${KR(net)}원</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('totalSalary').textContent = `${KR(totalSalary)}원`;
    document.getElementById('totalTax').textContent = `-${KR(totalTax)}원`;
    document.getElementById('totalNet').textContent = `${KR(totalNet)}원`;
    document.getElementById('totalHours').textContent = totalHours;

    document.getElementById('btnExportHome').onclick = () => {
      const aoa = [["작업자","일자","현장","공수","총급여","세금(3.3%)","실수령액"]];
      logs.forEach(r=>{
        const w = workerById(r.worker_id)||{};
        const salary=(r.md||0)*(w.daily||0);
        const tax=Math.round(salary*0.033);
        const net=salary-tax;
        aoa.push([w.name||'', r.date, siteName(r.site_id), r.md, salary, -tax, net]);
      });
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), `월간_${ym}`);
      XLSX.writeFile(wb, `월간_작업리스트_${ym}${wId?('_'+workerName(wId)):""}.xlsx`);
    };
  }

  /* ===== 작업 모달 ===== */
  let modalDate = '';
  function openLogModal(date){
    modalDate = date;
    const d = new Date(date);
    document.getElementById('modalDate').textContent = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} 작업기록`;

    const wrap = document.getElementById('modalRows');
    wrap.innerHTML='';
    db.workLogs.filter(w=>w.date===date).forEach(r=> wrap.appendChild(makeLog2Row(r)) );

    document.getElementById('btnCloseModal').onclick = () => document.getElementById('logModal').close();
    document.getElementById('btnSaveLogs').onclick = saveModalRows;
    document.getElementById('btnAddRow').onclick = () => wrap.appendChild(makeLog2Row(null));
    document.getElementById('logModal').showModal();
  }
  function makeLog2Row(r){
    const div=document.createElement('div');
    div.className='log-2row';
    div.dataset.id = r?.id || 'new';

    const siteOps = db.sites.map(s=>`<option value="${s.id}" ${r?.site_id===s.id?'selected':''}>${s.name}</option>`).join('');
    const workerOps = db.workers.map(w=>`<option value="${w.id}" ${r?.worker_id===w.id?'selected':''}>${w.name}</option>`).join('');

    div.innerHTML = `
      <select class="site">${siteOps}</select>
      <select class="worker">${workerOps}</select>
      <input class="md" type="number" step="0.5" min="0" value="${r?.md ?? 1}">
      <div class="row2">
        <input class="note" placeholder="메모" value="${r?.note || ''}">
        <button class="btn warn del">삭제</button>
      </div>
    `;
    
    // 공수 입력 필드에 이벤트 리스너 추가
    const mdInput = div.querySelector('.md');
    const updateMdColor = () => {
      const value = parseFloat(mdInput.value) || 0;
      if (value === 0 || value === 0.5) {
        mdInput.classList.add('zero');
      } else {
        mdInput.classList.remove('zero');
      }
    };
    
    // 초기 색상 설정
    updateMdColor();
    
    // 입력 시 색상 업데이트
    mdInput.addEventListener('input', updateMdColor);
    mdInput.addEventListener('change', updateMdColor);
    
    div.querySelector('.del').onclick = () => { div.remove(); };
    return div;
  }
  async function saveModalRows(){
    const wrap = document.getElementById('modalRows');
    const rows = [...wrap.querySelectorAll('.log-2row')];
    const keep = rows.map(row=>({
      id: row.dataset.id !== 'new' ? row.dataset.id : undefined,
      date: modalDate,
      site_id: row.querySelector('.site').value,
      worker_id: row.querySelector('.worker').value,
      md: parseFloat(row.querySelector('.md').value||0),
      note: row.querySelector('.note').value
    })).filter(r=> r.md>=0 && r.site_id && r.worker_id);

    await supabase.from('work_logs').delete().eq('date', modalDate);
    if (keep.length) await supabase.from('work_logs').insert(keep.map(({id,...rest})=>rest));
    await loadRecent();
    document.getElementById('logModal').close();
    renderCal(); renderHomeList();
  }

  /* ===== 경비관리 ===== */
      function initExpense(){
      fillSiteSelect(document.getElementById('exSite'));
      document.getElementById('exDate').value = fmtYMD(new Date());

    fillWorkerSelect(document.getElementById('linkWorker'));
    document.getElementById('linkMonth').value = fmtYM(new Date());
    drawLinkedWork();

    document.querySelectorAll('.accordion-header').forEach(h=> h.addEventListener('click', ()=> h.parentElement.classList.toggle('active')));
    document.getElementById('linkMonth').onchange = drawLinkedWork;
    document.getElementById('linkWorker').onchange = drawLinkedWork;

    document.getElementById('btnExcelFill').onclick = () => document.getElementById('excelFile').click();
    document.getElementById('excelFile').onchange = async e => {
      const f = e.target.files?.[0];
      if (!f) return;
      try{
        const data = new Uint8Array(await f.arrayBuffer());
        const wb = XLSX.read(data, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1 });
        // 헤더 행 찾기
        const headerRow = rows[0] || [];
        const headerMap = {};
        headerRow.forEach((header, index) => {
          if (header) {
            const headerStr = String(header).toLowerCase().trim();
            headerMap[headerStr] = index;
          }
        });
        
        // 데이터 행 처리 (첫 번째 데이터 행 사용)
        const dataRow = rows.slice(1).find(r => r && r.length > 0) || [];
        
        // 항목 매핑 및 자동 입력
        const categoryMap = {
          '아침': '아침', 'breakfast': '아침',
          '점심': '점심', 'lunch': '점심',
          '저녁': '저녁', 'dinner': '저녁',
          '유류': '유류', 'fuel': '유류', '기름': '유류',
          '숙박': '숙박', 'hotel': '숙박', 'lodging': '숙박',
          '잡자재': '잡자재', 'materials': '잡자재', '자재': '잡자재',
          '장비': '장비', 'equipment': '장비',
          'npc-1000': 'NPC-1000', 'npc1000': 'NPC-1000',
          '운임': '운임', 'transport': '운임', '교통비': '운임',
          '기타': '기타', 'etc': '기타', 'other': '기타'
        };
        
        // 각 필드에 대해 매핑 시도
        Object.keys(headerMap).forEach(headerKey => {
          const columnIndex = headerMap[headerKey];
          const value = dataRow[columnIndex];
          
          if (value !== undefined && value !== null) {
            const valueStr = String(value).trim();
            
            // 현장 필드 매핑 - 드롭다운에서 선택
            if (headerKey.includes('현장') || headerKey.includes('site') || headerKey.includes('location')) {
              const siteSelect = document.getElementById('exSite');
              // 현장명으로 드롭다운에서 해당 옵션 찾기
              for (let i = 0; i < siteSelect.options.length; i++) {
                if (siteSelect.options[i].text === valueStr) {
                  siteSelect.selectedIndex = i;
                  break;
                }
              }
            }
            // 사용일 필드 매핑
            else if (headerKey.includes('사용일') || headerKey.includes('date') || headerKey.includes('날짜')) {
              // 날짜 형식 변환 (YYYY-MM-DD)
              let dateValue = valueStr;
              if (dateValue.includes('/')) {
                const parts = dateValue.split('/');
                if (parts.length === 3) {
                  dateValue = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                }
              }
              document.getElementById('exDate').value = dateValue;
            }
            // 작업자 필드 매핑
            else if (headerKey.includes('작업자') || headerKey.includes('worker') || headerKey.includes('employee')) {
              document.getElementById('exWorker').value = valueStr;
            }
            // 항목 필드 매핑
            else if (headerKey.includes('항목') || headerKey.includes('category') || headerKey.includes('item')) {
              const mappedCategory = categoryMap[valueStr.toLowerCase()];
              if (mappedCategory) {
                document.getElementById('exCategory').value = mappedCategory;
              } else {
                document.getElementById('exCategory').value = valueStr;
              }
            }
            // 금액 필드 매핑
            else if (headerKey.includes('금액') || headerKey.includes('amount') || headerKey.includes('price') || headerKey.includes('cost')) {
              const numValue = parseInt(valueStr.replace(/[^\d]/g, '')) || 0;
              document.getElementById('exAmount').value = numValue;
            }
            // 사용처 필드 매핑
            else if (headerKey.includes('사용처') || headerKey.includes('vendor') || headerKey.includes('store') || headerKey.includes('shop')) {
              document.getElementById('exVendor').value = valueStr;
            }
            // 주소 필드 매핑
            else if (headerKey.includes('주소') || headerKey.includes('address') || headerKey.includes('location')) {
              document.getElementById('exAddress').value = valueStr;
            }
            // 메모 필드 매핑
            else if (headerKey.includes('메모') || headerKey.includes('memo') || headerKey.includes('note') || headerKey.includes('비고')) {
              document.getElementById('exMemo').value = valueStr;
            }
          }
        });
        
        alert('엑셀 내용이 입력폼에 반영되었습니다.\n모든 필드가 자동으로 매핑되었습니다.');
      } catch(err){
        alert('엑셀 파싱 실패: 파일 내용을 확인하세요.');
      } finally { e.target.value=''; }
    };

    document.getElementById('btnSaveExpense').onclick = onSaveExpense;

    // 필터 초기화 및 이벤트
    fillSiteSelect(document.getElementById('ledgerSite'));
    document.getElementById('ledgerMonth').value = fmtYM(new Date());
    ['ledgerSite','ledgerMonth'].forEach(id => document.getElementById(id).onchange = redrawExpense);
    redrawExpense();
  }

      function mapUIToExpense(){
      const siteId = document.getElementById('exSite').value;
      return {
        id: Date.now(),
        date: document.getElementById('exDate').value,
        site_id: siteId,
        worker_name: document.getElementById('exWorker').value.trim(),
        category: document.getElementById('exCategory').value.trim(),
        amount: parseInt(document.getElementById('exAmount').value || 0, 10),
        vendor: document.getElementById('exVendor').value.trim(),
        address: document.getElementById('exAddress').value.trim(),
        memo: document.getElementById('exMemo').value.trim()
      };
    }
  function validateExpense(ex){
    if (!ex.date) return { ok:false, message:'사용일이 비었습니다.' };
    if (!ex.site_id) return { ok:false, message:'현장을 선택하세요.' };
          if (!ex.category) return { ok:false, message:'항목을 입력하세요.' };
      if (!ex.worker_name) return { ok:false, message:'작업자를 입력하세요.' };
    if (!Number.isInteger(ex.amount) || ex.amount <= 0) return { ok:false, message:'금액을 1원 이상 정수로 입력하세요.' };
    return { ok:true };
  }
      function resetExpenseForm(){
      document.getElementById('exDate').value = fmtYMD(new Date());
      document.getElementById('exWorker').value = '';
      document.getElementById('exCategory').value = '';
      document.getElementById('exAmount').value = '';
      document.getElementById('exVendor').value = '';
      document.getElementById('exAddress').value = '';
      document.getElementById('exMemo').value = '';
    }
  async function onSaveExpense(){
    const ex = mapUIToExpense();
    const v = validateExpense(ex);
    if (!v.ok){ alert('지출 저장 오류: '+v.message); return; }

    const btn = document.getElementById('btnSaveExpense');
    btn.disabled=true; btn.innerHTML='<div class="loading-spinner"></div> 저장 중...';
    
    try{
      const { error } = await supabase.from('expenses').insert([ex]);
      if (error) throw error;
      resetExpenseForm();
      await loadRecent();
      redrawExpense();
      alert('지출 저장 완료');
    } catch(err){
      console.error('지출 저장 오류:', err);
      alert('지출 저장 오류: ' + (err?.message || '알 수 없는 오류'));
    } finally {
      btn.disabled=false; btn.innerHTML='<i class="fas fa-save"></i> 지출 저장';
    }
  }
  function drawLinkedWork(){
    const month = document.getElementById('linkMonth').value;
    const workerId = document.getElementById('linkWorker').value;
    const tbody = document.querySelector('#logLinkTable tbody');
    tbody.innerHTML='';

    const logs = month ? db.workLogs.filter(r=>r.date.startsWith(month)) : db.workLogs;
    const filtered = workerId ? logs.filter(r=>r.worker_id===workerId) : logs;

    filtered.sort((a,b)=>a.date.localeCompare(b.date)).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.date}</td><td>${siteName(r.site_id)}</td><td>${workerName(r.worker_id)}</td><td>${r.md}</td>`;
      tr.style.cursor='pointer';
      tr.onclick = ()=>{
        document.getElementById('exSite').value = r.site_id;
        document.getElementById('exDate').value = r.date;
        document.getElementById('exWorker').value = r.worker_id;
      };
      tbody.appendChild(tr);
    });
  }
  function redrawExpense(){
    const siteId = document.getElementById('ledgerSite').value;
    const month = document.getElementById('ledgerMonth').value;

    const homeSiteId = document.getElementById('homeSite')?.value || null;

    const { rows: laborRows, totalHours, totalGross, totalTax, totalNet } = computeLaborRows(siteId, month, homeSiteId);
    renderLaborTable(document.getElementById('laborTable'), laborRows, totalHours, totalGross, totalTax, totalNet, 'labor');

    const { rows: expenseRows, total: expenseTotal } = computeExpenseRows(siteId, month, homeSiteId);
    renderExpenseTable(document.getElementById('expenseTable'), expenseRows, expenseTotal, true);

    // 예산 합산
    let totalBudget = 0;
    if (siteId){
      const s = db.sites.find(x=>x.id===siteId); totalBudget = s? (s.budget||0) : 0;
    } else {
      totalBudget = db.sites.reduce((sum,s)=> sum + (s.budget||0), 0);
    }

    const profit = totalBudget - totalGross - expenseTotal;
    const setWon = (id,val) => { const el=document.getElementById(id); if(el) el.textContent = KR(val)+'원'; };
    setWon('calcBudget', totalBudget);
    setWon('calcLabor', totalGross);
    setWon('calcExpense', expenseTotal);
    const pEl = document.getElementById('calcProfit');
    if (pEl){ 
      pEl.textContent = KR(profit)+'원'; 
      pEl.className = `number ${profit>=0? 'text-blue':'text-red'}`; 
    }

// 엑셀 내보내기 (현장/월/인건비 현황/경비 현황만)
document.getElementById('btnExportLedger').onclick = () => {
  const wb = XLSX.utils.book_new();
  const siteLabel  = siteId ? siteName(siteId) : '전체 현장';
  const monthLabel = month || '전체 기간';

  // 1) 인건비 현황 시트
  const laborSheetData = [
    ['현장', siteLabel],
    ['월', monthLabel],
    [],
    ['작업자','일자','현장','공수','총급여','세금(3.3%)','실수령액']
  ];

  laborRows.forEach(row => {
    // 숫자 재계산(엑셀에서 계산 가능하도록)
    const w = workerById(row.worker_id) || {};
    const md = Number(row.md || 0);
    const gross = md * (w.daily || 0);
    const tax = Math.round(gross * 0.033);
    const net = gross - tax;

    laborSheetData.push([
      row.worker,
      row.date,
      row.site,
      md,
      gross,   // 총급여 숫자
      -tax,    // 세금은 음수로 표시
      net      // 실수령액 숫자
    ]);
  });

  // 총계 행 (숫자)
  laborSheetData.push(['', '', '', '합계', totalGross, -totalTax, totalNet]);

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.aoa_to_sheet(laborSheetData),
    '인건비 현황'
  );

  // 2) 경비 현황 시트
  const expenseSheetData = [
    ['현장', siteLabel],
    ['월', monthLabel],
    [],
    ['사용일','작업자','항목','금액','사용처','주소','메모']
  ];

  expenseRows.forEach(row => {
    // 금액 문자열(예: "12,000원") -> 숫자
    const amt = typeof row.amount === 'number'
      ? row.amount
      : parseInt(String(row.amount).replace(/[^\d]/g, ''), 10) || 0;

    expenseSheetData.push([
      row.date,
      row.worker_name,
      row.category,
      amt,         // 숫자
      row.vendor,
      row.address,
      row.memo
    ]);
  });

  // 총계 행 (숫자)
  expenseSheetData.push(['', '', '', '합계', '', '', '']); // 시각용 행
  expenseSheetData.push(['', '', '', expenseTotal, '', '', '']);

  XLSX.utils.book_append_sheet(
    wb,
    XLSX.utils.aoa_to_sheet(expenseSheetData),
    '경비 현황'
  );

  // 저장
  const safeMonth = monthLabel.replace(/[^\d-]/g, '') || '전체';
  const fileName = `금전출납부_${siteLabel}_${safeMonth}.xlsx`;
  XLSX.writeFile(wb, fileName);
};
  }

  /* 경비 삭제 */
  window.deleteExpense = async function(expenseId){
    if (!confirm('해당 지출 항목을 삭제하시겠습니까?')) return;
    try {
      const { error } = await supabase.from('expenses').delete().eq('id', expenseId);
      if (error) throw error;
      await loadRecent();
      redrawExpense();
      alert('지출 항목이 삭제되었습니다.');
    } catch (err) {
      console.error('지출 삭제 오류:', err);
      alert('지출 삭제 실패: ' + (err?.message || '알 수 없는 오류'));
    }
  };

  /* ===== 수익분석 ===== */
  function initProfit(){
    fillSiteSelect(document.getElementById('profitSite'));
    document.getElementById('profitMonth').value = fmtYM(new Date());
    ['profitSite','profitMonth'].forEach(id => document.getElementById(id).onchange = renderProfit);
    renderProfit();
    
    // 아코디언 초기화
    document.querySelectorAll('.accordion-header').forEach(h => {
      h.accordionClickHandler = () => h.parentElement.classList.toggle('active');
      h.addEventListener('click', h.accordionClickHandler);
    });
  }
  function renderProfit(){
    const siteId = document.getElementById('profitSite').value;
    const month = document.getElementById('profitMonth').value;

    const homeSiteId = document.getElementById('homeSite')?.value || null;

    let totalBudget = 0;
    if (siteId){
      const s = db.sites.find(x=>x.id===siteId); totalBudget = s? (s.budget||0): 0;
    } else {
      totalBudget = db.sites.reduce((sum,s)=> sum + (s.budget||0), 0);
    }

    const { total: expenseTotal } = computeExpenseRows(siteId, month, homeSiteId);
    
    // 인건비 총액 계산 (년-월 기준 누적)
    const profitLaborRows = computeProfitLaborRows(siteId, month, homeSiteId);
    const laborTotalGross = profitLaborRows.reduce((sum, row) => {
      return sum + parseInt(row.salary.replace(/[^\d]/g, ''));
    }, 0);

    const tbody = document.querySelector('#siteFinanceTable tbody');
    tbody.innerHTML='';
    let financeTotalProfit = 0;

    const sites = siteId ? db.sites.filter(s=>s.id===siteId) : db.sites;
    sites.forEach(s=>{
      const logsAll = db.workLogs.filter(l=>l.site_id===s.id);
      const expsAll = db.expenses.filter(e=>e.site_id===s.id);
      const months = new Set();
      if (month){ months.add(month); }
      else {
        logsAll.forEach(l=> months.add(l.date.substring(0,7)));
        expsAll.forEach(e=> months.add(e.date.substring(0,7)));
      }

      let firstMonthInPeriod;
      if (month) {
        firstMonthInPeriod = month;
      } else {
        const allMonths = [...new Set([...logsAll.map(l => l.date.substring(0,7)), ...expsAll.map(e => e.date.substring(0,7))])].sort();
        firstMonthInPeriod = allMonths.length ? allMonths[0] : null;
      }

      [...months].sort().forEach(m=>{
        const logs = logsAll.filter(l=> l.date.startsWith(m));
        const exps = expsAll.filter(e=> e.date.startsWith(m));
        const laborGross = logs.reduce((sum,l)=>{ const w = workerById(l.worker_id) || {}; return sum + (l.md||0)*(w.daily||0); },0);
        const expenseSum = exps.reduce((sum,e)=> sum+(e.amount||0), 0);

        const budget = (m === firstMonthInPeriod) ? (s.budget||0) : 0;
        const profit = budget - laborGross - expenseSum;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m}</td><td>${s.name||''}</td><td>${KR(budget)}원</td><td>${KR(laborGross)}원</td><td>${KR(expenseSum)}원</td><td>${KR(profit)}원</td>`;
        tbody.appendChild(tr);
        financeTotalProfit += profit;
      });
    });

    const put = (id, v) => { const el=document.getElementById(id); if(el) el.textContent = KR(v)+'원'; };
    put('profitCardTotalBudget', totalBudget);
    put('profitCardTotalLabor', laborTotalGross);
    put('profitCardTotalExpense', expenseTotal);
    const netEl = document.getElementById('profitCardNetProfit');
    if (netEl){ netEl.textContent = KR(financeTotalProfit)+'원'; netEl.className = `number ${financeTotalProfit>=0?'text-blue':'text-red'}`; }

    // 년-월 기준 누적 데이터 표시
    renderProfitLaborTable(document.getElementById('payWorkerTable'), profitLaborRows);

    const ftL = document.getElementById('financeTotalLabor');
    const ftE = document.getElementById('financeTotalExpense');
    const ftP = document.getElementById('financeTotalProfit');
    if (ftL) ftL.textContent = KR(laborTotalGross)+'원';
    if (ftE) ftE.textContent = KR(expenseTotal)+'원';
    if (ftP) ftP.textContent = KR(financeTotalProfit)+'원';
    
    // 아코디언 초기화 (동적으로 로드된 콘텐츠용)
    setTimeout(() => {
      document.querySelectorAll('.accordion-header').forEach(h => {
        // 기존 이벤트 리스너 제거
        h.removeEventListener('click', h.accordionClickHandler);
        // 새로운 이벤트 리스너 추가
        h.accordionClickHandler = () => h.parentElement.classList.toggle('active');
        h.addEventListener('click', h.accordionClickHandler);
      });
    }, 100);
  }

  /* ===== 관리자 ===== */
  function initAdmin(){
    // 공통 유틸 함수
    const parseNumberValue = (value) => {
      const trimmed = value.trim();
      return trimmed === '' ? null : parseInt(trimmed, 10);
    };
    
    const clearFormFields = (fieldIds) => {
      fieldIds.forEach(id => document.getElementById(id).value = '');
    };

    const wT = document.getElementById('workerTable');

    const drawW = () => {
      wT.innerHTML = `
        <thead><tr><th>작업자명</th><th>일당</th><th class="actions"></th></tr></thead>
        <tbody>
          ${db.workers.map(w=> `
            <tr>
              <td><input value='${w.name}' data-id='${w.id}' class='wName wNameRow'></td>
              <td><input type='number' value='${w.daily || ''}' data-id='${w.id}' class='wDaily wDailyRow'></td>
              <td class="actions"><button class='btn warn btn--delete' onclick="delWorker('${w.id}')">삭제</button></td>
            </tr>
          `).join('')}
        </tbody>
      `;
    };
    drawW();

    document.getElementById('btnAddWorker').onclick = async () => {
      const name = document.getElementById('admWorkerName').value.trim();
      const daily = parseNumberValue(document.getElementById('admDaily').value);
      if (!name || daily === null) return alert('작업자명과 일당을 입력');
      const { error } = await supabase.from('workers').insert({ name, daily });
      if (error){ alert('작업자 추가 실패: '+error.message); }
      else {
        clearFormFields(['admWorkerName','admDaily']);
        await loadBase(); drawW();
      }
    };
    
    window.delWorker = async function(id){
      if (!confirm('해당 작업자를 삭제하시겠습니까?')) return;
      const { error } = await supabase.from('workers').delete().eq('id', id);
      if (error){ alert('삭제 실패: '+error.message); }
      else { await loadBase(); drawW(); }
    };
    
    wT.onchange = async e => {
      const id = e.target.getAttribute('data-id');
      const w = db.workers.find(x=>x.id===id);
      if (!w) return;
      if (e.target.classList.contains('wDailyRow')) {
        w.daily = parseNumberValue(e.target.value);
      }
      if (e.target.classList.contains('wNameRow')) w.name = e.target.value;
      const { error } = await supabase.from('workers').update(w).eq('id', id);
      if (error) console.error('작업자 정보 업데이트 오류:', error);
    };

    const sT = document.getElementById('siteTable');
    const drawS = () => {
      sT.innerHTML = `
        <thead><tr><th>회사</th><th>현장명</th><th>총 예산</th><th class="actions"></th></tr></thead>
        <tbody>
          ${db.sites.map(s=> `
            <tr>
              <td><input value='${s.company_name||''}' data-id='${s.id}' class='sCompany sCompanyRow' onfocus="expandInput(this)" onblur="restoreInput(this)"></td>
              <td><input value='${s.name}' data-id='${s.id}' class='sName sNameRow' onfocus="expandInput(this)" onblur="restoreInput(this)"></td>
              <td><input type='number' value='${s.budget || ''}' data-id='${s.id}' class='sBudget sBudgetRow'></td>
              <td class="actions"><button class='btn warn btn--delete' onclick="delSite('${s.id}')">삭제</button></td>
            </tr>
          `).join('')}
        </tbody>
      `;
    };
    drawS();

    document.getElementById('btnAddSite').onclick = async () => {
      const company_name = document.getElementById('admCompanyName').value.trim();
      const name = document.getElementById('admSiteName').value.trim();
      const budget = parseNumberValue(document.getElementById('admSiteBudget').value);
      if (!name) return alert('현장명을 입력');
      const { error } = await supabase.from('sites').insert({ company_name, name, budget });
      if (error){ alert('현장 추가 실패: '+error.message); }
      else {
        clearFormFields(['admCompanyName','admSiteName','admSiteBudget']);
        await loadBase(); drawS();
      }
    };
    
    window.delSite = async function(id){
      if (!confirm('해당 현장을 삭제하시겠습니까?')) return;
      const { error } = await supabase.from('sites').delete().eq('id', id);
      if (error){ alert('현장 삭제 실패: '+error.message); }
      else { await loadBase(); drawS(); }
    };
    
    // 입력박스 확장/복원 함수 (공통)
    window.expandInput = function(input) {
      const screenWidth = window.innerWidth;
      let expandWidth = '120%';
      let minWidth = '120px';
      
      // 입력박스 타입에 따라 다른 확장 크기 설정
      if (input.classList.contains('sCompanyRow')) {
        expandWidth = '120%';
        minWidth = '120px';
      } else if (input.classList.contains('sNameRow')) {
        expandWidth = '130%';
        minWidth = '140px';
      }
      
      // 화면 크기에 따른 조정
      if (screenWidth <= 360) {
        expandWidth = '140%';
        minWidth = '100px';
      } else if (screenWidth <= 480) {
        expandWidth = '130%';
        minWidth = '110px';
      } else if (screenWidth <= 768) {
        expandWidth = '125%';
        minWidth = '120px';
      }
      
      input.style.width = expandWidth;
      input.style.minWidth = minWidth;
      input.style.zIndex = '10';
      input.style.position = 'relative';
    };
    
    window.restoreInput = function(input) {
      input.style.width = '';
      input.style.minWidth = '';
      input.style.zIndex = '';
      input.style.position = '';
    };
    
    sT.onchange = async e => {
      const id = e.target.getAttribute('data-id');
      const s = db.sites.find(x=>x.id===id);
      if (!s) return;
      if (e.target.classList.contains('sCompanyRow')) s.company_name = e.target.value;
      if (e.target.classList.contains('sNameRow')) s.name = e.target.value;
      if (e.target.classList.contains('sBudgetRow')) {
        s.budget = parseNumberValue(e.target.value);
      }
      const { error } = await supabase.from('sites').update(s).eq('id', id);
      if (error) console.error('현장 정보 업데이트 오류:', error);
    };
  }

  /* ===== 라우팅 ===== */
  function initNav(){
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const route = btn.getAttribute('data-route');
        if (route !== appState.currentRoute) {
          saveViewState(appState.currentRoute);
          appState.currentRoute = route;
          await mountView();
          document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          history.pushState({ route, viewState: appState.viewStates[route] }, '', `#${route}`);
        }
      });
    });
  }
  function saveViewState(route){
    const s = {};
    if (route==='home'){
      s.month = document.getElementById('monthPicker')?.value||'';
      s.worker = document.getElementById('homeWorker')?.value||'';
    } else if (route==='expense'){
      s.site = document.getElementById('exSite')?.value||'';
      s.date = document.getElementById('exDate')?.value||'';
      s.worker = document.getElementById('exWorker')?.value||'';
      s.category = document.getElementById('exCategory')?.value||'';
      s.amount = document.getElementById('exAmount')?.value||'';
      s.vendor = document.getElementById('exVendor')?.value||'';
      s.address = document.getElementById('exAddress')?.value||'';
      s.memo = document.getElementById('exMemo')?.value||'';
      s.ledgerSite = document.getElementById('ledgerSite')?.value||'';
      s.ledgerMonth = document.getElementById('ledgerMonth')?.value||'';
    } else if (route==='profit'){
      s.site = document.getElementById('profitSite')?.value||'';
      s.month = document.getElementById('profitMonth')?.value||'';
    } else if (route==='admin'){
      s.workerName = document.getElementById('admWorkerName')?.value||'';
      s.daily = document.getElementById('admDaily')?.value||'';
      s.companyName = document.getElementById('admCompanyName')?.value||'';
      s.siteName = document.getElementById('admSiteName')?.value||'';
      s.budget = document.getElementById('admSiteBudget')?.value||'';
    }
    appState.viewStates[route] = s;
  }
  function restoreViewState(route){
    const s = appState.viewStates[route] || {};
    if (route==='home'){
      if (s.month) document.getElementById('monthPicker').value = s.month;
      if (s.worker) document.getElementById('homeWorker').value = s.worker;
    } else if (route==='expense'){
      if (s.site) document.getElementById('exSite').value = s.site;
      if (s.date) document.getElementById('exDate').value = s.date;
      if (s.worker) document.getElementById('exWorker').value = s.worker;
      if (s.category) document.getElementById('exCategory').value = s.category;
      if (s.amount) document.getElementById('exAmount').value = s.amount;
      if (s.vendor) document.getElementById('exVendor').value = s.vendor;
      if (s.address) document.getElementById('exAddress').value = s.address;
      if (s.memo) document.getElementById('exMemo').value = s.memo;
      if (s.ledgerSite) document.getElementById('ledgerSite').value = s.ledgerSite;
      if (s.ledgerMonth) document.getElementById('ledgerMonth').value = s.ledgerMonth;
    } else if (route==='profit'){
      if (s.site) document.getElementById('profitSite').value = s.site;
      if (s.month) document.getElementById('profitMonth').value = s.month;
    } else if (route==='admin'){
      if (s.workerName) document.getElementById('admWorkerName').value = s.workerName;
      if (s.daily) document.getElementById('admDaily').value = s.daily;
      if (s.companyName) document.getElementById('admCompanyName').value = s.companyName;
      if (s.siteName) document.getElementById('admSiteName').value = s.siteName;
      if (s.budget) document.getElementById('admSiteBudget').value = s.budget;
    }
  }
  async function mountView(){
    const v = document.getElementById('view');
    const t = document.getElementById(appState.currentRoute + 'Tpl');
    v.innerHTML = '';
    v.appendChild(t.content.cloneNode(true));

    if (appState.currentRoute === 'home') {
      const logTpl = document.getElementById('logTpl');
      if (logTpl) {
        v.appendChild(logTpl.content.cloneNode(true));
      }
    }

    restoreViewState(appState.currentRoute);

    if (appState.currentRoute === 'home') initHome();
    if (appState.currentRoute === 'expense') initExpense();
    if (appState.currentRoute === 'profit') initProfit();
    if (appState.currentRoute === 'admin') initAdmin();
  }

  /* ===== 테마 ===== */
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const theme = savedTheme || (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
    updateThemeToggle(theme);
  }
  function updateThemeToggle(theme){
    const toggle = document.getElementById('themeToggle');
    if (!toggle) return;
    toggle.checked = theme === 'dark';
  }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    updateThemeToggle(next);
  }

  /* ===== PWA 앱 설치 기능 ===== */
  function initPWAInstall() {
    // 앱 설치 상태 확인
    function isPWAInstalled() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.matchMedia('(display-mode: fullscreen)').matches ||
             window.matchMedia('(display-mode: minimal-ui)').matches;
    }

    // beforeinstallprompt 이벤트 핸들러
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      pwaState.deferredPrompt = e;

      // 앱이 설치되어 있지 않으면 버튼을 보여줍니다.
      if (!isPWAInstalled()) {
        const installBtn = document.getElementById('installAppBtn');
        if (installBtn) {
          installBtn.style.display = 'flex';
        }
      }
    });

    // 앱 설치 버튼 클릭 핸들러
    const installBtn = document.getElementById('installAppBtn');
    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        if (!pwaState.deferredPrompt) return;
        
        installBtn.disabled = true;
        installBtn.innerHTML = '<div class="loading-spinner"></div> 설치 중...';
        
        try {
          const { outcome } = await pwaState.deferredPrompt.prompt();
          pwaState.deferredPrompt = null;
          
          if (outcome === 'accepted') {
            installBtn.style.display = 'none';
          }
        } catch (error) {
          console.error('앱 설치 오류:', error);
        } finally {
          installBtn.disabled = false;
          installBtn.innerHTML = '<i class="fas fa-download"></i> 앱 설치';
        }
      });
    }

    // 앱이 설치되었을 때 버튼을 제거합니다.
    window.addEventListener('appinstalled', () => {
      pwaState.isInstalled = true;
      const installBtn = document.getElementById('installAppBtn');
      if (installBtn) {
        installBtn.style.display = 'none';
      }
    });

    // 페이지 로드 시 앱 설치 상태 확인
    window.addEventListener('load', () => {
      if (isPWAInstalled()) {
        const installBtn = document.getElementById('installAppBtn');
        if (installBtn) {
          installBtn.style.display = 'none';
        }
      }
    });
  }

  /* ===== 데이터 로드 ===== */
  async function loadBase() {
    const [wRes, sRes] = await Promise.all([
      supabase.from('workers').select('id, name, daily').order('name', { ascending:true }),
      supabase.from('sites').select('id, company_name, name, budget').order('name', { ascending:true })
    ]);
    if (wRes.error) console.error('작업자 로드 오류:', wRes.error);
    if (sRes.error) console.error('현장 로드 오류:', sRes.error);
    db.workers = wRes.data || [];
    db.sites = sRes.data || [];
  }
  async function loadRecent() {
    const from = getFromDate(90);
    const [wlRes, exRes] = await Promise.all([
      supabase.from('work_logs').select('id, date, site_id, worker_id, md, note').gte('date', from),
      supabase.from('expenses').select('id, date, site_id, worker_name, category, amount, vendor, address, memo').gte('date', from)
    ]);
    if (wlRes.error) console.error('작업 로그 로드 오류:', wlRes.error);
    if (exRes.error) console.error('경비 로드 오류:', exRes.error);
    db.workLogs = wlRes.data || [];
    db.expenses = exRes.data || [];
  }

  /* ===== 초기 데이터 (비어있을 때만) ===== */
  async function initializeData() {
    try {
      const { count: wc } = await supabase.from('workers').select('*', { count: 'exact', head: true });
      if (!wc) await supabase.from('workers').insert([{ name: '김작업', daily: 150000 }, { name: '이관리', daily: 180000 }]);

      const { count: sc } = await supabase.from('sites').select('*', { count: 'exact', head: true });
      if (!sc) await supabase.from('sites').insert([
        { company_name: 'INOPNC', name: '시흥시청역 현장', budget: 80000000 },
        { company_name: 'INOPNC', name: '부천 대장 현장', budget: 120000000 }
      ]);
    } catch (e) { console.error('초기 데이터 설정 오류:', e); }
  }

  /* ===== 뒤로가기/새로고침 ===== */
  document.getElementById('btnBack').addEventListener('click', ()=> history.back());
  
  // 개선된 새로고침 기능 - 로딩 스피너만 표시
  document.getElementById('btnRefresh').addEventListener('click', async function() {
    const btn = this;
    const originalContent = btn.innerHTML;
    
    // 로딩 상태 표시 - 텍스트 제거하고 스피너만 표시
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner"></div>';
    
    try {
      // 현재 상태 저장
      saveViewState(appState.currentRoute);
      
              // 기본 데이터와 최근 데이터 모두 새로고침
        await Promise.all([loadBase(), loadRecent()]);
      
      // 현재 뷰 새로고침
      if (appState.currentRoute === 'home') {
        renderCal();
        renderHomeList();
              } else if (appState.currentRoute === 'expense') {
          fillSiteSelect(document.getElementById('exSite')); // 드롭다운 옵션 다시 채우기
          fillWorkerSelect(document.getElementById('exWorker')); // 드롭다운 옵션 다시 채우기
          fillWorkerSelect(document.getElementById('linkWorker'));
          fillSiteSelect(document.getElementById('ledgerSite'));
          drawLinkedWork();
          redrawExpense();
        } else if (appState.currentRoute === 'profit') {
          fillSiteSelect(document.getElementById('profitSite'));
          renderProfit();
        } else if (appState.currentRoute === 'admin') {
          await mountView();
        }
      
              // 성공 알림 (간단히)
        btn.style.transform = 'scale(1.1)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 200);
        
        // 성공 메시지 표시
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
          position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
          background: #10b981; color: white; padding: 8px 16px;
          border-radius: 20px; font-size: 12px; font-weight: 600;
          z-index: 1000; animation: slideDown 0.3s ease;
        `;
        successMsg.textContent = '새로고침 완료';
        document.body.appendChild(successMsg);
        setTimeout(() => successMsg.remove(), 2000);
        
      } catch (error) {
      console.error('새로고침 오류:', error);
      alert('새로고침 중 오류가 발생했습니다. 다시 시도해주세요.');
    } finally {
      // 버튼 원래 상태로 복원
      btn.disabled = false;
      btn.innerHTML = originalContent;
    }
  });

  /* ===== 실시간 ===== */
  supabase.channel('realtime-all')
    .on('postgres_changes', { event:'*', schema:'public', table:'work_logs' }, async ()=>{ 
      await loadRecent(); 
      if (appState.currentRoute==='home'){ 
        renderCal(); 
        renderHomeList(); 
      }
    })
    .on('postgres_changes', { event:'*', schema:'public', table:'expenses' }, async ()=>{ 
      await loadRecent(); 
      if (appState.currentRoute==='expense'){ 
        redrawExpense(); 
      }
    })
    .subscribe();

  /* ===== 히스토리 ===== */
  function initHistory(){
    const savedState = sessionStorage.getItem('appState');
    if (savedState){
      try{
        const st = JSON.parse(savedState);
        appState.currentRoute = st.route || 'home';
        appState.viewStates = st.viewStates || appState.viewStates;
        history.replaceState(st, '', `#${appState.currentRoute}`);
      } catch(e){ console.error('상태 복원 오류:', e); }
    }
    window.addEventListener('popstate', (e)=>{
      const st=e.state || { route:'home', viewState:{} };
      appState.currentRoute = st.route;
      appState.viewStates = { ...appState.viewStates, [st.route]: st.viewState || {} };
      mountView();
    });
    window.addEventListener('beforeunload', ()=> sessionStorage.setItem('appState', JSON.stringify({ route: appState.currentRoute, viewStates: appState.viewStates })) );
  }

  /* ===== 네트워크 상태 감시 ===== */
  function initNetworkStatus() {
    function updateOnlineStatus() {
      const indicator = document.getElementById('offlineIndicator');
      if (navigator.onLine) {
        indicator.classList.remove('show');
        pwaState.isOnline = true;
      } else {
        indicator.classList.add('show');
        pwaState.isOnline = false;
      }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  }

  /* ===== PWA 기능 ===== */
  function initPWA() {
    // 네트워크 상태 감시
    initNetworkStatus();
    
    // Service Worker 등록
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          // Service Worker 파일 존재 확인
          const response = await fetch('/service-worker.js', { method: 'HEAD' });
          if (!response.ok) {
            console.warn('Service Worker 파일을 찾을 수 없습니다');
            return;
          }

          const registration = await navigator.serviceWorker.register('/service-worker.js', {
            scope: '/'
          });
          
          console.log('Service Worker 등록 성공:', registration.scope);
          
          // 업데이트 감지
          registration.addEventListener('updatefound', () => {
            const installingWorker = registration.installing;
            installingWorker.addEventListener('statechange', () => {
              if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('새 버전이 발견되었습니다. 페이지를 새로고침하세요.');
                // 사용자에게 알림 표시
                if (confirm('새 버전이 있습니다. 페이지를 새로고침하시겠습니까?')) {
                  window.location.reload();
                }
              }
            });
          });
        } catch (error) {
          console.error('Service Worker 등록 실패:', error);
        }
      });
    }
  }

  /* ===== 초기화 ===== */
  async function init(){
    // PWA 초기화
    initPWA();
    
    // PWA 앱 설치 기능 초기화
    initPWAInstall();
    
    // 기본 초기화
    initTheme();
    initNav();
    initHistory();
    document.getElementById('themeToggle').addEventListener('change', toggleTheme);
    
    // INOPNC 로고 클릭 시 홈으로 이동
    document.getElementById('brandLogo').addEventListener('click', () => {
      if (appState.currentRoute !== 'home') {
        saveViewState(appState.currentRoute);
        appState.currentRoute = 'home';
        mountView();
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-route="home"]').classList.add('active');
        history.pushState({ route: 'home', viewState: appState.viewStates['home'] }, '', '#home');
      }
    });
    
    // 데이터 초기화
    await initializeData();
    await loadBase();
    await loadRecent();
    await mountView();
  }

  // 앱 시작
  if (window.requestIdleCallback) {
    requestIdleCallback(() => init(), { timeout: 2000 });
  } else {
    setTimeout(() => init(), 0);
  }
  </script>
</body>
</html>